# ## Задача: Базовый bootstrap кластера
# - **Статус**: В процессе
# - **Описание**: Подготовить ноды, runtime, Kubernetes и сетевые компоненты.
- name: Base OS preparation on all nodes
  hosts: all
  become: true
  gather_facts: true
  roles:
    - role: base_os
      tags: [base]
    - role: proxy
      tags: [base, proxy]
      when: proxy_enabled | bool

- name: Install runtime on Kubernetes nodes
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: container_runtime
      tags: [runtime, k8s]

- name: Configure control-plane VIP endpoint
  hosts: control_plane
  become: true
  gather_facts: true
  roles:
    - role: control_plane_vip
      tags: [vip, k8s, control-plane]

- name: Apply security hardening on Kubernetes nodes
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: security_hardening
      tags: [security, k8s]

- name: Bootstrap and join Kubernetes nodes
  hosts: k8s_cluster
  become: true
  gather_facts: true
  roles:
    - role: kubernetes_core
      tags: [k8s]

- name: Configure CNI
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: networking
      tags: [network, k8s]

- name: Configure MetalLB
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: metallb
      tags: [metallb, ingress]

- name: Deploy ingress-nginx in node-IP mode
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: ingress_nginx
      tags: [ingress, k8s]

- name: Deploy kube-prometheus-stack
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: prometheus_stack
      tags: [observability, prometheus, k8s]
      when: deploy_prometheus_stack | default(false) | bool

- name: Deploy GitLab Runner
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: gitlab_runner
      tags: [ci, gitlab-runner, k8s]
      when: deploy_gitlab_runner | default(false) | bool

- name: Deploy k8tz
  hosts: control_plane[0]
  become: true
  gather_facts: true
  roles:
    - role: k8tz
      tags: [k8tz, addons, k8s]
      when: deploy_k8tz | default(false) | bool
