# ## Задача: Роль base_os
# - **Статус**: В процессе
# - **Описание**: Базовая подготовка ОС перед установкой Kubernetes.
- name: Validate base OS variables
  ansible.builtin.assert:
    that:
      - redos_release is defined
      - base_os_packages is iterable
      - base_os_kernel_modules is iterable
    fail_msg: "Base OS variables are incomplete"

- name: Set system hostname from inventory name
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: base_os_manage_hostname | bool

- name: Manage /etc/hosts entries from inventory
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED INVENTORY HOSTS"
    block: |
      {% for host in groups['all'] %}
      {{ hostvars[host].ansible_host | default(host) }} {{ host }}
      {% endfor %}
  when: base_os_manage_hosts_file | bool

- name: Install baseline packages
  ansible.builtin.package:
    name: "{{ base_os_packages }}"
    state: present

- name: Get active NetworkManager connection for primary interface
  ansible.builtin.command: >-
    nmcli -t -f NAME,DEVICE connection show --active
  register: base_os_nmcli_active_connections
  changed_when: false
  failed_when: false
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0

- name: Resolve active NetworkManager profile name
  ansible.builtin.set_fact:
    base_os_nm_profile_name: >-
      {{
        (
          base_os_nmcli_active_connections.stdout_lines
          | default([])
          | select('search', ':(%s)$' % (ansible_default_ipv4.interface | default('')))
          | map('regex_replace', ':(.+)$', '')
          | list
          | first
        ) | default('')
      }}
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0

- name: Ensure active NetworkManager profile was detected
  ansible.builtin.assert:
    that:
      - base_os_nm_profile_name | default('') | length > 0
    fail_msg: >-
      Unable to detect active NetworkManager profile for interface
      {{ ansible_default_ipv4.interface | default('unknown') }}.
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0

- name: Read current NetworkManager DNS settings
  ansible.builtin.command: >-
    nmcli -g ipv4.dns,ipv4.ignore-auto-dns connection show "{{ base_os_nm_profile_name }}"
  register: base_os_nm_dns_current
  changed_when: false
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0
    - base_os_nm_profile_name | default('') | length > 0

- name: Calculate desired NetworkManager DNS settings
  ansible.builtin.set_fact:
    base_os_nm_dns_desired_servers: "{{ dns_servers | join(',') }}"
    base_os_nm_dns_desired_ignore_auto: "{{ 'yes' if (base_os_networkmanager_ignore_auto_dns | bool) else 'no' }}"
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0
    - base_os_nm_profile_name | default('') | length > 0

- name: Configure DNS servers via NetworkManager profile
  ansible.builtin.command: >-
    nmcli connection modify "{{ base_os_nm_profile_name }}"
    ipv4.dns "{{ dns_servers | join(' ') }}"
    ipv4.ignore-auto-dns {{ 'yes' if (base_os_networkmanager_ignore_auto_dns | bool) else 'no' }}
  register: base_os_nm_dns_config
  changed_when: true
  when:
    - base_os_manage_networkmanager_dns | bool
    - dns_servers | default([]) | length > 0
    - base_os_nm_profile_name | default('') | length > 0
    - (base_os_nm_dns_current.stdout_lines | default(['', '']))[0] != base_os_nm_dns_desired_servers
      or (base_os_nm_dns_current.stdout_lines | default(['', '']))[1] != base_os_nm_dns_desired_ignore_auto

- name: Apply NetworkManager profile after DNS update
  ansible.builtin.command: >-
    nmcli connection up "{{ base_os_nm_profile_name }}"
  register: base_os_nm_dns_apply
  changed_when: true
  when:
    - base_os_nm_dns_config is changed

- name: Check resolved resolv.conf target availability
  ansible.builtin.stat:
    path: "{{ base_os_resolv_conf_target }}"
  register: base_os_resolv_conf_target_stat
  when:
    - base_os_manage_resolv_conf_symlink | bool

- name: Ensure resolved resolv.conf target exists
  ansible.builtin.assert:
    that:
      - base_os_resolv_conf_target_stat.stat.exists | default(false)
    fail_msg: >-
      Resolv.conf target {{ base_os_resolv_conf_target }} is missing.
      Ensure systemd-resolved is configured before forcing /etc/resolv.conf symlink.
  when:
    - base_os_manage_resolv_conf_symlink | bool

- name: Force /etc/resolv.conf to non-stub resolved file
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: link
    src: "{{ base_os_resolv_conf_target }}"
    force: true
  when:
    - base_os_manage_resolv_conf_symlink | bool

- name: Configure kernel modules for Kubernetes
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    mode: "0644"
    content: |
      {% for module in base_os_kernel_modules %}
      {{ module }}
      {% endfor %}

- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ base_os_kernel_modules }}"

- name: Configure sysctl settings for Kubernetes
  ansible.builtin.template:
    src: k8s-sysctl.conf.j2
    dest: /etc/sysctl.d/99-kubernetes.conf
    mode: "0644"
  notify: Apply sysctl settings

- name: Disable zram0 swap on RedOS 8
  block:
    - name: Stop and mask zram systemd units
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
        masked: true
      loop:
        - zramswap.service
        - systemd-zram-setup@zram0.service
      failed_when: false

    - name: Ensure zram-generator override directory exists
      ansible.builtin.file:
        path: /etc/systemd/zram-generator.conf.d
        state: directory
        mode: "0755"

    - name: Configure zram-generator override to disable zram0
      ansible.builtin.copy:
        dest: /etc/systemd/zram-generator.conf.d/99-ansible-disable-zram0.conf
        mode: "0644"
        content: |
          [zram0]
          zram-size = 0

    - name: Reload systemd after zram0 override
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Disable zram0 swap immediately
      ansible.builtin.command: swapoff /dev/zram0
      register: base_os_zram_swapoff
      changed_when: base_os_zram_swapoff.rc == 0
      failed_when: false

    - name: Check active swap devices after zram0 disable
      ansible.builtin.command: swapon --show --noheadings --raw
      register: base_os_active_swaps
      changed_when: false

    - name: Ensure zram0 is not active in swap list
      ansible.builtin.assert:
        that:
          - (base_os_active_swaps.stdout | default('')) is not search('/dev/zram0')
        fail_msg: "zram0 is still active as swap device after disable sequence"
  when:
    - base_os_disable_swap | bool
    - base_os_disable_zram0 | bool
    - (redos_release | string) is search('^8(\\.|$)')

- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  when:
    - base_os_disable_swap | bool
    - ansible_swaptotal_mb | int > 0
  changed_when: true

- name: Disable swap in fstab for persistence
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(\\S+\\s+\\S+\\s+swap\\s+.*)$'
    replace: '# \\1'
  when: base_os_disable_swap | bool

- name: Configure chrony NTP servers
  ansible.builtin.blockinfile:
    path: /etc/chrony.conf
    marker: "# {mark} ANSIBLE MANAGED NTP"
    block: |
      {% for server in ntp_servers | default([]) %}
      server {{ server }} iburst
      {% endfor %}
  when: base_os_manage_time | bool
  notify: Restart chronyd

- name: Ensure chronyd is enabled and running
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: true
  when: base_os_manage_time | bool
