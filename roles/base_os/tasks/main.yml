# ## Задача: Роль base_os
# - **Статус**: В процессе
# - **Описание**: Базовая подготовка ОС перед установкой Kubernetes.
- name: Validate base OS variables
  ansible.builtin.assert:
    that:
      - redos_release is defined
      - base_os_packages is iterable
      - base_os_kernel_modules is iterable
    fail_msg: "Base OS variables are incomplete"

- name: Set system hostname from inventory name
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: base_os_manage_hostname | bool

- name: Manage /etc/hosts entries from inventory
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED INVENTORY HOSTS"
    block: |
      {% for host in groups['all'] %}
      {{ hostvars[host].ansible_host | default(host) }} {{ host }}
      {% endfor %}
  when: base_os_manage_hosts_file | bool

- name: Install baseline packages
  ansible.builtin.package:
    name: "{{ base_os_packages }}"
    state: present

- name: Configure kernel modules for Kubernetes
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    mode: "0644"
    content: |
      {% for module in base_os_kernel_modules %}
      {{ module }}
      {% endfor %}

- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ base_os_kernel_modules }}"

- name: Configure sysctl settings for Kubernetes
  ansible.builtin.template:
    src: k8s-sysctl.conf.j2
    dest: /etc/sysctl.d/99-kubernetes.conf
    mode: "0644"
  notify: Apply sysctl settings

- name: Disable zram0 swap on RedOS 8
  block:
    - name: Stop and mask zram systemd units
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
        masked: true
      loop:
        - zramswap.service
        - systemd-zram-setup@zram0.service
      failed_when: false

    - name: Ensure zram-generator override directory exists
      ansible.builtin.file:
        path: /etc/systemd/zram-generator.conf.d
        state: directory
        mode: "0755"

    - name: Configure zram-generator override to disable zram0
      ansible.builtin.copy:
        dest: /etc/systemd/zram-generator.conf.d/99-ansible-disable-zram0.conf
        mode: "0644"
        content: |
          [zram0]
          zram-size = 0

    - name: Reload systemd after zram0 override
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Disable zram0 swap immediately
      ansible.builtin.command: swapoff /dev/zram0
      register: base_os_zram_swapoff
      changed_when: base_os_zram_swapoff.rc == 0
      failed_when: false

    - name: Check active swap devices after zram0 disable
      ansible.builtin.command: swapon --show --noheadings --raw
      register: base_os_active_swaps
      changed_when: false

    - name: Ensure zram0 is not active in swap list
      ansible.builtin.assert:
        that:
          - (base_os_active_swaps.stdout | default('')) is not search('/dev/zram0')
        fail_msg: "zram0 is still active as swap device after disable sequence"
  when:
    - base_os_disable_swap | bool
    - base_os_disable_zram0 | bool
    - (redos_release | string) is search('^8(\\.|$)')

- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  when:
    - base_os_disable_swap | bool
    - ansible_swaptotal_mb | int > 0
  changed_when: true

- name: Disable swap in fstab for persistence
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(\\S+\\s+\\S+\\s+swap\\s+.*)$'
    replace: '# \\1'
  when: base_os_disable_swap | bool

- name: Configure chrony NTP servers
  ansible.builtin.blockinfile:
    path: /etc/chrony.conf
    marker: "# {mark} ANSIBLE MANAGED NTP"
    block: |
      {% for server in ntp_servers | default([]) %}
      server {{ server }} iburst
      {% endfor %}
  when: base_os_manage_time | bool
  notify: Restart chronyd

- name: Ensure chronyd is enabled and running
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: true
  when: base_os_manage_time | bool
