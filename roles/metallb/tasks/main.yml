# ## Задача: Роль metallb
# - **Статус**: В процессе
# - **Описание**: Установка и конфигурация MetalLB.
- name: Resolve MetalLB variables for control-plane context
  ansible.builtin.set_fact:
    metallb_ref_host: "{{ groups['metallb'][0] }}"
    resolved_metallb_mode: "{{ metallb_mode | default(hostvars[groups['metallb'][0]].metallb_mode | default('l2')) }}"
    resolved_metallb_address_pools: "{{ metallb_address_pools | default(hostvars[groups['metallb'][0]].metallb_address_pools) }}"
    resolved_metallb_node_labels: "{{ metallb_node_labels | default(hostvars[groups['metallb'][0]].metallb_node_labels | default([])) }}"

- name: Validate MetalLB settings
  ansible.builtin.assert:
    that:
      - groups['metallb'] | length > 0
      - resolved_metallb_mode in ['l2', 'bgp']
      - resolved_metallb_address_pools is defined
      - resolved_metallb_address_pools | length > 0
    fail_msg: "MetalLB settings are incomplete"

- name: Apply MetalLB base manifest
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ metallb_kubeconfig }}
    apply -f {{ metallb_manifest_url }}
  register: metallb_install
  changed_when: "'created' in metallb_install.stdout or 'configured' in metallb_install.stdout"
  environment: "{{ proxy_environment }}"

- name: Wait for MetalLB controller rollout
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ metallb_kubeconfig }}
    -n {{ metallb_namespace }} rollout status deployment/controller --timeout=300s
  changed_when: false

- name: Wait for MetalLB speaker rollout
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ metallb_kubeconfig }}
    -n {{ metallb_namespace }} rollout status daemonset/speaker --timeout=300s
  changed_when: false

- name: Wait for MetalLB webhook endpoints to become ready
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ metallb_kubeconfig }}
    -n {{ metallb_namespace }} get endpoints metallb-webhook-service
    -o jsonpath='{.subsets[*].addresses[*].ip}'
  register: metallb_webhook_endpoints
  changed_when: false
  until: (metallb_webhook_endpoints.stdout | default('') | trim | length) > 0
  retries: "{{ metallb_webhook_endpoints_retries | int }}"
  delay: "{{ metallb_webhook_endpoints_delay | int }}"

- name: Render MetalLB pool configuration
  ansible.builtin.template:
    src: metallb-config.yaml.j2
    dest: /tmp/metallb-config.yaml
    mode: "0644"

- name: Apply MetalLB pool configuration
  block:
    - name: Temporarily delete MetalLB validating webhook configuration
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ metallb_kubeconfig }}
        delete validatingwebhookconfiguration {{ metallb_webhook_configuration_name }}
        --ignore-not-found=true
      register: metallb_webhook_delete
      changed_when: "'deleted' in (metallb_webhook_delete.stdout | default(''))"
      when: metallb_webhook_delete_recreate_workaround_enabled | bool

    - name: Apply MetalLB pool configuration manifest
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ metallb_kubeconfig }}
        apply -f /tmp/metallb-config.yaml
      register: metallb_pool_apply
      changed_when: "'created' in metallb_pool_apply.stdout or 'configured' in metallb_pool_apply.stdout"
      retries: "{{ metallb_pool_apply_retries | int }}"
      delay: "{{ metallb_pool_apply_delay | int }}"
      until: metallb_pool_apply.rc == 0
  rescue:
    - name: Collect MetalLB pods diagnostics after pool apply failure
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ metallb_kubeconfig }}
        -n {{ metallb_namespace }} get pods -o wide
      register: metallb_pods_diag
      changed_when: false
      failed_when: false

    - name: Collect MetalLB events diagnostics after pool apply failure
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ metallb_kubeconfig }}
        -n {{ metallb_namespace }} get events --sort-by=.lastTimestamp
      register: metallb_events_diag
      changed_when: false
      failed_when: false

    - name: Fail with MetalLB webhook diagnostics
      ansible.builtin.fail:
        msg: |
          MetalLB pool configuration apply failed after retries.
          apply rc={{ metallb_pool_apply.rc | default('n/a') }}
          apply stderr={{ metallb_pool_apply.stderr | default('') | trim }}
          webhook endpoints:
          {{ metallb_webhook_endpoints.stdout | default('') | trim }}
          metallb pods:
          {{ metallb_pods_diag.stdout | default('') | trim }}
          metallb events:
          {{ metallb_events_diag.stdout | default('') | trim }}
  always:
    - name: Restore MetalLB validating webhook configuration
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ metallb_kubeconfig }}
        apply -f {{ metallb_manifest_url }}
      register: metallb_webhook_restore
      changed_when: >-
        'created' in (metallb_webhook_restore.stdout | default(''))
        or 'configured' in (metallb_webhook_restore.stdout | default(''))
      environment: "{{ proxy_environment | default({}) }}"
      when: metallb_webhook_delete_recreate_workaround_enabled | bool

- name: Apply labels to dedicated MetalLB nodes
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ metallb_kubeconfig }}
    label node {{ item.0 }} {{ item.1 }} --overwrite
  loop: "{{ groups['metallb'] | product(resolved_metallb_node_labels) | list }}"
  changed_when: false
  when:
    - groups['metallb'] | length > 0
    - resolved_metallb_node_labels | length > 0
