# ## Задача: Роль kubernetes_core
# - **Статус**: В процессе
# - **Описание**: Управление установкой и bootstrap Kubernetes.
- name: Validate Kubernetes core variables
  ansible.builtin.assert:
    that:
      - kubernetes_version is defined
      - control_plane_endpoint is defined
      - pod_subnet_cidr is defined
      - service_subnet_cidr is defined
      - groups['control_plane'] | length > 0
    fail_msg: "Kubernetes core variables are incomplete"

- name: Define node role flags
  ansible.builtin.set_fact:
    primary_control_plane: "{{ groups['control_plane'][0] }}"
    is_primary_control_plane: "{{ inventory_hostname == groups['control_plane'][0] }}"
    is_control_plane_node: "{{ inventory_hostname in groups['control_plane'] }}"
    is_worker_like_node: "{{ inventory_hostname in (groups['workers'] + groups['metallb']) }}"

- name: Configure Kubernetes repository
  ansible.builtin.template:
    src: kubernetes.repo.j2
    dest: /etc/yum.repos.d/kubernetes.repo
    mode: "0644"

- name: Install Kubernetes packages
  ansible.builtin.package:
    name: "{{ kubernetes_packages }}"
    state: present

- name: Ensure kubelet is enabled
  ansible.builtin.service:
    name: kubelet
    enabled: true
    state: started

- name: Render kubeadm config on primary control-plane
  ansible.builtin.template:
    src: kubeadm-config.yaml.j2
    dest: "{{ kubeadm_config_path }}"
    mode: "0644"
  when: is_primary_control_plane | bool

- name: Initialize Kubernetes cluster on primary control-plane
  ansible.builtin.command: "kubeadm init --config {{ kubeadm_config_path }} --upload-certs"
  args:
    creates: /etc/kubernetes/admin.conf
  when: is_primary_control_plane | bool

- name: Ensure kube config exists for root
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: "0700"
  when: is_primary_control_plane | bool

- name: Copy admin kubeconfig to root
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: true
    mode: "0600"
  when: is_primary_control_plane | bool

- name: Ensure kube config exists for ansible user
  ansible.builtin.file:
    path: "/home/{{ kubernetes_admin_user }}/.kube"
    state: directory
    mode: "0700"
    owner: "{{ kubernetes_admin_user }}"
    group: "{{ kubernetes_admin_user }}"
  when:
    - is_primary_control_plane | bool
    - kubernetes_admin_user != 'root'

- name: Copy admin kubeconfig for ansible user
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: "/home/{{ kubernetes_admin_user }}/.kube/config"
    remote_src: true
    mode: "0600"
    owner: "{{ kubernetes_admin_user }}"
    group: "{{ kubernetes_admin_user }}"
  when:
    - is_primary_control_plane | bool
    - kubernetes_admin_user != 'root'

- name: Generate worker join command
  ansible.builtin.command: kubeadm token create --ttl 2h --print-join-command
  register: kubeadm_worker_join_command
  changed_when: false
  when: is_primary_control_plane | bool

- name: Upload control-plane certificates and capture key
  ansible.builtin.command: kubeadm init phase upload-certs --upload-certs
  register: kubeadm_upload_certs
  changed_when: false
  when: is_primary_control_plane | bool

- name: Save join commands on primary host facts
  ansible.builtin.set_fact:
    kubeadm_certificate_key: >-
      {{ kubeadm_upload_certs.stdout_lines | select('match', '^[a-f0-9]{64}$') | list | last | default('') }}
    kubeadm_join_worker_cmd: "{{ kubeadm_worker_join_command.stdout }}"
    kubeadm_join_control_plane_cmd: >-
      {{ kubeadm_worker_join_command.stdout }}
      --control-plane
      --certificate-key {{ kubeadm_upload_certs.stdout_lines | select('match', '^[a-f0-9]{64}$') | list | last | default('') }}
    cacheable: true
  when: is_primary_control_plane | bool

- name: Ensure worker join command is available
  ansible.builtin.assert:
    that:
      - hostvars[primary_control_plane].kubeadm_join_worker_cmd is defined
      - hostvars[primary_control_plane].kubeadm_join_worker_cmd | length > 0
    fail_msg: "Join command is not available from primary control-plane"
  when: not (is_primary_control_plane | bool)

- name: Join secondary control-plane nodes
  ansible.builtin.command: >-
    {{ hostvars[primary_control_plane].kubeadm_join_control_plane_cmd }}
    --apiserver-advertise-address {{ ansible_host }}
  args:
    creates: /etc/kubernetes/kubelet.conf
  when:
    - is_control_plane_node | bool
    - not (is_primary_control_plane | bool)

- name: Join worker and metallb nodes
  ansible.builtin.command: "{{ hostvars[primary_control_plane].kubeadm_join_worker_cmd }}"
  args:
    creates: /etc/kubernetes/kubelet.conf
  when: is_worker_like_node | bool
