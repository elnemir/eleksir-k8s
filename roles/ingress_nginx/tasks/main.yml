# ## Задача: Роль ingress_nginx
# - **Статус**: В процессе
# - **Описание**: Установка ingress-nginx в режиме DaemonSet + hostNetwork на ingress-нодах.
- name: Validate ingress-nginx settings
  ansible.builtin.assert:
    that:
      - groups['metallb'] | length > 0
      - ingress_nginx_release_name | length > 0
      - ingress_nginx_namespace | length > 0
      - ingress_nginx_chart_repo_name | length > 0
      - ingress_nginx_chart_repo_url | length > 0
      - ingress_nginx_chart_ref | length > 0
      - ingress_nginx_controller_node_selector_key | length > 0
      - ingress_nginx_controller_node_selector_value | length > 0
    fail_msg: "Ingress-nginx settings are incomplete"

- name: Check helm binary presence
  ansible.builtin.stat:
    path: "{{ ingress_nginx_helm_binary_path }}"
  register: ingress_nginx_helm_binary_stat

- name: Resolve architecture for ingress-nginx helm bootstrap
  ansible.builtin.set_fact:
    ingress_nginx_helm_arch: "{{ ingress_nginx_helm_arch_map.get(ansible_architecture, 'amd64') }}"
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Ensure temporary directory for ingress-nginx helm bootstrap exists
  ansible.builtin.file:
    path: "{{ ingress_nginx_helm_tmp_dir }}"
    state: directory
    mode: "0755"
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Check helm archive presence before bootstrap download
  ansible.builtin.stat:
    path: "{{ ingress_nginx_helm_tmp_dir }}/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz"
  register: ingress_nginx_helm_archive_stat_before
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Download helm archive for ingress-nginx bootstrap
  ansible.builtin.get_url:
    url: "https://get.helm.sh/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz"
    dest: "{{ ingress_nginx_helm_tmp_dir }}/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz"
    mode: "0644"
    force: false
  register: ingress_nginx_helm_archive_download
  retries: "{{ ingress_nginx_helm_download_retries | int }}"
  delay: "{{ ingress_nginx_helm_download_delay | int }}"
  until: ingress_nginx_helm_archive_download is succeeded
  environment: "{{ proxy_environment | default({}) }}"
  when:
    - not (ingress_nginx_helm_binary_stat.stat.exists | default(false))
    - not (
        (ingress_nginx_helm_archive_stat_before.stat.exists | default(false))
        and ((ingress_nginx_helm_archive_stat_before.stat.size | default(0) | int) >= (ingress_nginx_helm_archive_min_size_bytes | int))
      )

- name: Validate helm archive availability after bootstrap download
  ansible.builtin.stat:
    path: "{{ ingress_nginx_helm_tmp_dir }}/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz"
  register: ingress_nginx_helm_archive_stat_after
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Ensure helm archive is valid for ingress-nginx bootstrap
  ansible.builtin.assert:
    that:
      - ingress_nginx_helm_archive_stat_after.stat.exists | default(false)
      - (ingress_nginx_helm_archive_stat_after.stat.size | default(0) | int) >= (ingress_nginx_helm_archive_min_size_bytes | int)
    fail_msg: >-
      Helm archive is missing or too small for ingress bootstrap:
      {{ ingress_nginx_helm_tmp_dir }}/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz
      size={{ ingress_nginx_helm_archive_stat_after.stat.size | default(0) }} bytes.
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Extract helm archive for ingress-nginx bootstrap
  ansible.builtin.unarchive:
    src: "{{ ingress_nginx_helm_tmp_dir }}/helm-{{ ingress_nginx_helm_version }}-linux-{{ ingress_nginx_helm_arch }}.tar.gz"
    dest: "{{ ingress_nginx_helm_tmp_dir }}"
    remote_src: true
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Install helm binary for ingress-nginx bootstrap
  ansible.builtin.copy:
    src: "{{ ingress_nginx_helm_tmp_dir }}/linux-{{ ingress_nginx_helm_arch }}/helm"
    dest: "{{ ingress_nginx_helm_binary_path }}"
    remote_src: true
    mode: "0755"
  when: not (ingress_nginx_helm_binary_stat.stat.exists | default(false))

- name: Re-check helm binary availability
  ansible.builtin.stat:
    path: "{{ ingress_nginx_helm_binary_path }}"
  register: ingress_nginx_helm_binary_stat_after_bootstrap

- name: Ensure helm binary is available after bootstrap
  ansible.builtin.assert:
    that:
      - ingress_nginx_helm_binary_stat_after_bootstrap.stat.exists | default(false)
    fail_msg: "Helm binary is missing after bootstrap at {{ ingress_nginx_helm_binary_path }}"

- name: Ensure ingress-nginx helm repository is configured
  ansible.builtin.command: >-
    {{ ingress_nginx_helm_binary_path }} repo add {{ ingress_nginx_chart_repo_name }} {{ ingress_nginx_chart_repo_url }}
  register: ingress_nginx_repo_add
  changed_when: "'has been added' in (ingress_nginx_repo_add.stdout | default(''))"
  failed_when: >-
    ingress_nginx_repo_add.rc != 0
    and 'already exists' not in (ingress_nginx_repo_add.stderr | default(''))
  environment: "{{ (proxy_environment | default({})) | combine({'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'}) }}"

- name: Refresh helm repositories
  ansible.builtin.command: "{{ ingress_nginx_helm_binary_path }} repo update"
  register: ingress_nginx_repo_update
  changed_when: false
  environment: "{{ (proxy_environment | default({})) | combine({'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'}) }}"

- name: Render ingress-nginx values
  ansible.builtin.template:
    src: values.yaml.j2
    dest: "{{ ingress_nginx_values_path }}"
    mode: "0644"

- name: Deploy ingress-nginx release in node-IP mode
  ansible.builtin.command: >-
    {{ ingress_nginx_helm_binary_path }} upgrade --install {{ ingress_nginx_release_name }} {{ ingress_nginx_chart_ref }}
    --kubeconfig {{ ingress_nginx_kubeconfig }}
    --namespace {{ ingress_nginx_namespace }}
    --create-namespace
    -f {{ ingress_nginx_values_path }}
    --wait --timeout {{ ingress_nginx_wait_timeout }}
  register: ingress_nginx_release
  changed_when: >-
    'Installing it now' in (ingress_nginx_release.stdout | default(''))
    or 'has been upgraded' in (ingress_nginx_release.stdout | default(''))
  environment: "{{ (proxy_environment | default({})) | combine({'PATH': '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'}) }}"

- name: Wait for ingress-nginx controller rollout
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ ingress_nginx_kubeconfig }}
    -n {{ ingress_nginx_namespace }}
    rollout status daemonset/{{ ingress_nginx_release_name }}-controller
    --timeout={{ ingress_nginx_wait_timeout }}
  changed_when: false
