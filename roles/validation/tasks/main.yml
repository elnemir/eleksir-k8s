# ## Задача: Роль validation
# - **Статус**: В процессе
# - **Описание**: Проверка критериев приемки кластера.
- name: Validate acceptance criteria baseline
  ansible.builtin.assert:
    that:
      - ansible_require_check_diff_support | bool
      - ingress_controller is defined
      - groups['control_plane'] | length == 3
    fail_msg: "Acceptance baseline variables are incomplete"

- name: Get Kubernetes nodes state
  ansible.builtin.command: kubectl --kubeconfig={{ validation_kubeconfig }} get nodes --no-headers
  register: validation_nodes
  changed_when: false

- name: Calculate expected node count
  ansible.builtin.set_fact:
    validation_expected_node_count: >-
      {{ (groups['control_plane'] | length) + (groups['workers'] | length) + (groups['metallb'] | length) }}

- name: Ensure all nodes are Ready
  ansible.builtin.assert:
    that:
      - validation_nodes.stdout_lines | length == validation_expected_node_count
      - validation_nodes.stdout_lines | select('search', '\\sReady') | list | length == validation_nodes.stdout_lines | length
    fail_msg: "Not all Kubernetes nodes are Ready"

- name: Check MetalLB controller readiness
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_metallb_namespace }}
    get deployment controller -o jsonpath='{.status.readyReplicas}'
  register: validation_metallb_controller
  changed_when: false

- name: Ensure MetalLB controller has ready replicas
  ansible.builtin.assert:
    that:
      - validation_metallb_controller.stdout | int > 0
    fail_msg: "MetalLB controller is not ready"

- name: Read ingress service type and VIP details
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_ingress_namespace }}
    get svc {{ validation_ingress_service_name }}
    -o jsonpath='{.spec.type}|{.status.loadBalancer.ingress[0].ip}|{.status.loadBalancer.ingress[0].hostname}'
  register: validation_ingress_service
  changed_when: false
  failed_when: false
  when: validation_enable_ingress_vip_check | bool

- name: Parse ingress service details
  ansible.builtin.set_fact:
    validation_ingress_service_type: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[0] }}
    validation_ingress_service_ip: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[1] }}
    validation_ingress_service_hostname: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[2] }}
  when: validation_enable_ingress_vip_check | bool

- name: Validate ingress service exposure and external address
  ansible.builtin.assert:
    that:
      - validation_ingress_service.rc == 0
      - validation_ingress_service_type == 'LoadBalancer'
      - (validation_ingress_service_ip | length > 0) or (validation_ingress_service_hostname | length > 0)
    fail_msg: >-
      Ingress service validation failed for {{ validation_ingress_namespace }}/{{ validation_ingress_service_name }}.
      type={{ validation_ingress_service_type | default('') }},
      ip={{ validation_ingress_service_ip | default('') }},
      hostname={{ validation_ingress_service_hostname | default('') }},
      rc={{ validation_ingress_service.rc | default(-1) }}.
  when: validation_enable_ingress_vip_check | bool

- name: Validate expected ingress VIP when fixed VIP is configured
  ansible.builtin.assert:
    that:
      - validation_ingress_expected_vip | length == 0 or validation_ingress_service_ip == validation_ingress_expected_vip
    fail_msg: >-
      Expected ingress VIP {{ validation_ingress_expected_vip }} but got {{ validation_ingress_service_ip | default('') }}
      for {{ validation_ingress_namespace }}/{{ validation_ingress_service_name }}.
  when: validation_enable_ingress_vip_check | bool

- name: Check NFS StorageClass existence
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    get storageclass {{ validation_nfs_storage_class_name }}
  register: validation_storageclass
  changed_when: false
  when: validation_enable_storage_check | bool

- name: Validate NFS StorageClass command output
  ansible.builtin.assert:
    that:
      - validation_storageclass.rc == 0
    fail_msg: "NFS StorageClass is missing"
  when: validation_enable_storage_check | bool

- name: Reminder for failover check
  ansible.builtin.debug:
    msg: >-
      Failover criterion requires operational test: temporarily stop one control-plane node
      and confirm cluster remains healthy.
  when: validation_enable_failover_check | bool
  changed_when: false
