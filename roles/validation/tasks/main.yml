# ## Задача: Роль validation
# - **Статус**: В процессе
# - **Описание**: Проверка критериев приемки кластера.
- name: Validate acceptance criteria baseline
  ansible.builtin.assert:
    that:
      - ansible_require_check_diff_support | bool
      - ingress_controller is defined
      - groups['control_plane'] | length == 3
    fail_msg: "Acceptance baseline variables are incomplete"

- name: Get Kubernetes nodes state
  ansible.builtin.command: kubectl --kubeconfig={{ validation_kubeconfig }} get nodes --no-headers
  register: validation_nodes
  changed_when: false

- name: Calculate expected node count
  ansible.builtin.set_fact:
    validation_expected_node_count: >-
      {{ (groups['control_plane'] | length) + (groups['workers'] | length) + (groups['metallb'] | length) }}

- name: Calculate validation feature toggles
  ansible.builtin.set_fact:
    validation_control_plane_vip_checks_enabled: >-
      {{
        (validation_enable_api_vip_check | bool)
        or (validation_enable_control_plane_vip_state_check | bool)
        or (validation_enable_control_plane_vip_failover_test | bool)
      }}
    validation_control_plane_vip_state_checks_enabled: >-
      {{
        (validation_enable_control_plane_vip_state_check | bool)
        or (validation_enable_control_plane_vip_failover_test | bool)
      }}
  changed_when: false

- name: Ensure all nodes are Ready
  ansible.builtin.assert:
    that:
      - validation_nodes.stdout_lines | length == validation_expected_node_count
      - validation_nodes.stdout_lines | select('search', '\\sReady') | list | length == validation_nodes.stdout_lines | length
    fail_msg: "Not all Kubernetes nodes are Ready"

- name: Read kubelet resolvConf from all k8s nodes
  ansible.builtin.command: >-
    awk '/^resolvConf:/{gsub(/^"|"$/, "", $2); print $2}' /var/lib/kubelet/config.yaml
  delegate_to: "{{ item }}"
  loop: "{{ groups['k8s_cluster'] }}"
  register: validation_kubelet_resolv_conf_values
  changed_when: false
  failed_when: false
  when: validation_enable_kubelet_resolv_conf_check | bool

- name: Ensure kubelet resolvConf is aligned on all k8s nodes
  ansible.builtin.assert:
    that:
      - (validation_kubelet_resolv_conf_values.results | rejectattr('rc', 'equalto', 0) | list | length) == 0
      - >-
        (
          validation_kubelet_resolv_conf_values.results
          | map(attribute='stdout')
          | map('trim')
          | map('regex_replace', '^"|"$', '')
          | reject('equalto', validation_kubelet_resolv_conf_expected)
          | list
          | length
        ) == 0
    fail_msg: >-
      kubelet resolvConf mismatch detected. Expected={{ validation_kubelet_resolv_conf_expected }}.
      Actual: {{
        validation_kubelet_resolv_conf_values.results
        | map(attribute='item')
        | zip(
            validation_kubelet_resolv_conf_values.results
            | map(attribute='stdout')
            | map('trim')
            | map('regex_replace', '^"|"$', '')
          )
        | map('join', '=')
        | join(', ')
      }}.
  when: validation_enable_kubelet_resolv_conf_check | bool

- name: Validate control-plane API VIP variables
  ansible.builtin.assert:
    that:
      - validation_control_plane_endpoint_host | length > 0
      - (validation_control_plane_endpoint_port | int) > 0
      - (validation_control_plane_endpoint_port | int) <= 65535
    fail_msg: "Control-plane API VIP validation variables are incomplete"
  when: validation_control_plane_vip_checks_enabled | bool

- name: Check Kubernetes API /readyz via control-plane VIP
  ansible.builtin.shell: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    --server=https://{{ validation_control_plane_endpoint_host }}:{{ validation_control_plane_endpoint_port }}
    {% if validation_api_vip_kubectl_insecure_skip_tls_verify | bool %}--insecure-skip-tls-verify=true{% endif %}
    get --raw={{ validation_api_readyz_path }}
  args:
    executable: /bin/bash
  register: validation_api_vip_readyz
  changed_when: false
  failed_when: false
  when: validation_enable_api_vip_check | bool

- name: Ensure Kubernetes API VIP endpoint is healthy
  ansible.builtin.assert:
    that:
      - validation_api_vip_readyz.rc == 0
      - (validation_api_vip_readyz.stdout | default('')) is search('ok')
    fail_msg: >-
      Kubernetes API VIP endpoint is not healthy:
      {{ validation_control_plane_endpoint_host }}:{{ validation_control_plane_endpoint_port }}{{ validation_api_readyz_path }}.
  when: validation_enable_api_vip_check | bool

- name: Check keepalived state on control-plane hosts
  ansible.builtin.command: systemctl is-active keepalived
  delegate_to: "{{ item }}"
  loop: "{{ groups['control_plane'] }}"
  register: validation_keepalived_states
  changed_when: false
  failed_when: false
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Ensure keepalived is active on all control-plane hosts
  ansible.builtin.assert:
    that:
      - (validation_keepalived_states.results | rejectattr('stdout', 'equalto', 'active') | list | length) == 0
    fail_msg: "keepalived is not active on one or more control-plane hosts"
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Check haproxy state on control-plane hosts
  ansible.builtin.command: systemctl is-active haproxy
  delegate_to: "{{ item }}"
  loop: "{{ groups['control_plane'] }}"
  register: validation_haproxy_states
  changed_when: false
  failed_when: false
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Ensure haproxy is active on all control-plane hosts
  ansible.builtin.assert:
    that:
      - (validation_haproxy_states.results | rejectattr('stdout', 'equalto', 'active') | list | length) == 0
    fail_msg: "haproxy is not active on one or more control-plane hosts"
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Detect control-plane VIP owners
  ansible.builtin.shell: "ip -4 -o addr show | awk '{print $4}' | cut -d/ -f1 | grep -Fx {{ validation_control_plane_endpoint_host }}"
  args:
    executable: /bin/bash
  delegate_to: "{{ item }}"
  loop: "{{ groups['control_plane'] }}"
  register: validation_vip_presence
  changed_when: false
  failed_when: false
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Build control-plane VIP owner list
  ansible.builtin.set_fact:
    validation_vip_owner_hosts: "{{ validation_vip_presence.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list }}"
  when: validation_control_plane_vip_state_checks_enabled | bool

- name: Ensure exactly one control-plane host owns the VIP
  ansible.builtin.assert:
    that:
      - validation_vip_owner_hosts | length == 1
    fail_msg: >-
      Expected exactly one VIP owner for {{ validation_control_plane_endpoint_host }},
      got {{ validation_vip_owner_hosts | default([]) | join(', ') }}.
  when: validation_enable_control_plane_vip_state_check | bool

- name: Precompute failover source host
  ansible.builtin.set_fact:
    validation_failover_source_host: "{{ (validation_vip_owner_hosts | default([]) | first) | default('') }}"
  when: validation_enable_control_plane_vip_failover_test | bool

- name: Optional control-plane VIP failover test
  block:
    - name: Ensure failover test has single source owner
      ansible.builtin.assert:
        that:
          - validation_vip_owner_hosts | length == 1
        fail_msg: "Cannot start failover test: VIP owner is not uniquely detected"

    - name: Set failover source host
      ansible.builtin.set_fact:
        validation_failover_source_host: "{{ validation_vip_owner_hosts[0] }}"

    - name: Stop keepalived on failover source host
      ansible.builtin.service:
        name: keepalived
        state: stopped
      delegate_to: "{{ validation_failover_source_host | default(inventory_hostname) }}"
      when: validation_failover_source_host | length > 0

    - name: Wait for VIP migration
      ansible.builtin.pause:
        seconds: "{{ validation_failover_wait_seconds | int }}"

    - name: Detect control-plane VIP owners after failover trigger
      ansible.builtin.shell: "ip -4 -o addr show | awk '{print $4}' | cut -d/ -f1 | grep -Fx {{ validation_control_plane_endpoint_host }}"
      args:
        executable: /bin/bash
      delegate_to: "{{ item }}"
      loop: "{{ groups['control_plane'] }}"
      register: validation_post_failover_vip_presence
      changed_when: false
      failed_when: false

    - name: Build post-failover VIP owner list
      ansible.builtin.set_fact:
        validation_post_failover_vip_owner_hosts: "{{ validation_post_failover_vip_presence.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list }}"

    - name: Ensure VIP moved to another control-plane host
      ansible.builtin.assert:
        that:
          - validation_post_failover_vip_owner_hosts | length == 1
          - validation_post_failover_vip_owner_hosts[0] != validation_failover_source_host
        fail_msg: >-
          VIP failover check failed. Source={{ validation_failover_source_host }},
          post-owners={{ validation_post_failover_vip_owner_hosts | default([]) | join(', ') }}.

    - name: Re-check Kubernetes API /readyz via VIP after failover
      ansible.builtin.shell: >-
        kubectl --kubeconfig={{ validation_kubeconfig }}
        --server=https://{{ validation_control_plane_endpoint_host }}:{{ validation_control_plane_endpoint_port }}
        {% if validation_api_vip_kubectl_insecure_skip_tls_verify | bool %}--insecure-skip-tls-verify=true{% endif %}
        get --raw={{ validation_api_readyz_path }}
      args:
        executable: /bin/bash
      register: validation_api_vip_readyz_after_failover
      changed_when: false
      failed_when: false

    - name: Ensure Kubernetes API VIP endpoint is healthy after failover
      ansible.builtin.assert:
        that:
          - validation_api_vip_readyz_after_failover.rc == 0
          - (validation_api_vip_readyz_after_failover.stdout | default('')) is search('ok')
        fail_msg: "Kubernetes API VIP endpoint is not healthy after failover"
  always:
    - name: Ensure keepalived is started on failover source host
      ansible.builtin.service:
        name: keepalived
        state: started
      delegate_to: "{{ validation_failover_source_host | default(inventory_hostname) }}"
      when: validation_failover_source_host | default('') | length > 0
  when: validation_enable_control_plane_vip_failover_test | bool

- name: Check MetalLB controller readiness
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_metallb_namespace }}
    get deployment controller -o jsonpath='{.status.readyReplicas}'
  register: validation_metallb_controller
  changed_when: false

- name: Ensure MetalLB controller has ready replicas
  ansible.builtin.assert:
    that:
      - validation_metallb_controller.stdout | int > 0
    fail_msg: "MetalLB controller is not ready"

- name: Validate ingress validation mode
  ansible.builtin.assert:
    that:
      - validation_ingress_validation_mode in ['loadbalancer', 'node_ip']
    fail_msg: "Unsupported ingress validation mode: {{ validation_ingress_validation_mode }}"
  when: validation_enable_ingress_vip_check | bool

- name: Read ingress service type and VIP details
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_ingress_namespace }}
    get svc {{ validation_ingress_service_name }}
    -o jsonpath='{.spec.type}|{.status.loadBalancer.ingress[0].ip}|{.status.loadBalancer.ingress[0].hostname}'
  register: validation_ingress_service
  changed_when: false
  failed_when: false
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'loadbalancer'

- name: Parse ingress service details
  ansible.builtin.set_fact:
    validation_ingress_service_type: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[0] }}
    validation_ingress_service_ip: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[1] }}
    validation_ingress_service_hostname: >-
      {{ ((validation_ingress_service.stdout.split('|') if (validation_ingress_service.stdout | length > 0) else []) + ['', '', ''])[2] }}
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'loadbalancer'

- name: Show ingress service lookup diagnostics when command fails
  ansible.builtin.debug:
    msg: >-
      Ingress service lookup failed for {{ validation_ingress_namespace }}/{{ validation_ingress_service_name }}:
      rc={{ validation_ingress_service.rc | default(-1) }},
      stdout={{ validation_ingress_service.stdout | default('') }},
      stderr={{ validation_ingress_service.stderr | default('') }}.
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'loadbalancer'
    - (validation_ingress_service.rc | default(1)) != 0
  changed_when: false

- name: Validate ingress service exposure and external address
  ansible.builtin.assert:
    that:
      - validation_ingress_service.rc == 0
      - validation_ingress_service_type == 'LoadBalancer'
      - (validation_ingress_service_ip | length > 0) or (validation_ingress_service_hostname | length > 0)
    fail_msg: >-
      Ingress service validation failed for {{ validation_ingress_namespace }}/{{ validation_ingress_service_name }}.
      type={{ validation_ingress_service_type | default('') }},
      ip={{ validation_ingress_service_ip | default('') }},
      hostname={{ validation_ingress_service_hostname | default('') }},
      rc={{ validation_ingress_service.rc | default(-1) }},
      stderr={{ validation_ingress_service.stderr | default('') }}.
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'loadbalancer'

- name: Validate expected ingress VIP when fixed VIP is configured
  ansible.builtin.assert:
    that:
      - validation_ingress_expected_vip | length == 0 or validation_ingress_service_ip == validation_ingress_expected_vip
    fail_msg: >-
      Expected ingress VIP {{ validation_ingress_expected_vip }} but got {{ validation_ingress_service_ip | default('') }}
      for {{ validation_ingress_namespace }}/{{ validation_ingress_service_name }}.
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'loadbalancer'

- name: Read ingress controller daemonset rollout status (node-ip mode)
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_ingress_namespace }}
    get daemonset {{ validation_ingress_controller_daemonset_name }}
    -o jsonpath='{.status.desiredNumberScheduled}|{.status.numberReady}|{.status.numberAvailable}'
  register: validation_ingress_daemonset_status
  changed_when: false
  failed_when: false
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Parse ingress controller daemonset status
  ansible.builtin.set_fact:
    validation_ingress_daemonset_desired: >-
      {{ ((validation_ingress_daemonset_status.stdout.split('|') if (validation_ingress_daemonset_status.stdout | default('') | length > 0) else []) + ['0', '0', '0'])[0] | int }}
    validation_ingress_daemonset_ready: >-
      {{ ((validation_ingress_daemonset_status.stdout.split('|') if (validation_ingress_daemonset_status.stdout | default('') | length > 0) else []) + ['0', '0', '0'])[1] | int }}
    validation_ingress_daemonset_available: >-
      {{ ((validation_ingress_daemonset_status.stdout.split('|') if (validation_ingress_daemonset_status.stdout | default('') | length > 0) else []) + ['0', '0', '0'])[2] | int }}
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Validate ingress controller daemonset readiness (node-ip mode)
  ansible.builtin.assert:
    that:
      - validation_ingress_daemonset_status.rc == 0
      - validation_ingress_daemonset_desired > 0
      - validation_ingress_daemonset_ready == validation_ingress_daemonset_desired
      - validation_ingress_daemonset_available == validation_ingress_daemonset_desired
    fail_msg: >-
      Ingress controller daemonset validation failed for
      {{ validation_ingress_namespace }}/{{ validation_ingress_controller_daemonset_name }}.
      desired={{ validation_ingress_daemonset_desired | default(0) }},
      ready={{ validation_ingress_daemonset_ready | default(0) }},
      available={{ validation_ingress_daemonset_available | default(0) }},
      rc={{ validation_ingress_daemonset_status.rc | default(-1) }},
      stderr={{ validation_ingress_daemonset_status.stderr | default('') }}.
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Read ingress controller pod nodes (node-ip mode)
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    -n {{ validation_ingress_namespace }}
    get pods -l {{ validation_ingress_controller_label_selector }}
    -o jsonpath='{range .items[*]}{.spec.nodeName}{"\n"}{end}'
  register: validation_ingress_controller_nodes_raw
  changed_when: false
  failed_when: false
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Parse ingress controller pod nodes (node-ip mode)
  ansible.builtin.set_fact:
    validation_ingress_controller_nodes: >-
      {{ validation_ingress_controller_nodes_raw.stdout_lines | default([]) | map('trim') | reject('equalto', '') | unique | list }}
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Validate ingress controller node placement (node-ip mode)
  ansible.builtin.assert:
    that:
      - validation_ingress_controller_nodes_raw.rc == 0
      - validation_ingress_controller_nodes | length > 0
      - (validation_ingress_controller_nodes | difference(groups['metallb'])) | length == 0
      - >-
        (not (validation_ingress_require_controller_on_all_metallb_nodes | bool))
        or ((groups['metallb'] | difference(validation_ingress_controller_nodes)) | length == 0)
    fail_msg: >-
      Ingress controller node placement validation failed.
      controller_nodes={{ validation_ingress_controller_nodes | default([]) | join(',') }},
      metallb_nodes={{ groups['metallb'] | default([]) | join(',') }},
      rc={{ validation_ingress_controller_nodes_raw.rc | default(-1) }},
      stderr={{ validation_ingress_controller_nodes_raw.stderr | default('') }}.
  when:
    - validation_enable_ingress_vip_check | bool
    - validation_ingress_validation_mode == 'node_ip'

- name: Check NFS StorageClass existence
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ validation_kubeconfig }}
    get storageclass {{ validation_nfs_storage_class_name }}
  register: validation_storageclass
  changed_when: false
  when: validation_enable_storage_check | bool

- name: Validate NFS StorageClass command output
  ansible.builtin.assert:
    that:
      - validation_storageclass.rc == 0
    fail_msg: "NFS StorageClass is missing"
  when: validation_enable_storage_check | bool

- name: Reminder for failover check
  ansible.builtin.debug:
    msg: >-
      For automated control-plane VIP failover test use:
      -e validation_enable_control_plane_vip_failover_test=true
  when:
    - validation_enable_failover_check | bool
    - not (validation_enable_control_plane_vip_failover_test | bool)
  changed_when: false
