# ## Задача: Роль container_runtime
# - **Статус**: В процессе
# - **Описание**: Подготовка container runtime для Kubernetes.
- name: Validate runtime selection
  ansible.builtin.assert:
    that:
      - container_runtime_name in ['containerd', 'crio']
      - container_runtime_packages_map[container_runtime_name] is iterable
      - container_runtime_cri_tools_package is string
    fail_msg: "Supported runtimes: containerd, crio"

- name: Install container runtime packages
  ansible.builtin.package:
    name: "{{ container_runtime_packages_map[container_runtime_name] }}"
    state: present

- name: Check if crictl binary is already present
  ansible.builtin.command: command -v crictl
  register: container_runtime_crictl_probe
  changed_when: false
  failed_when: false

- name: Install cri-tools package when explicitly enabled and crictl is missing
  ansible.builtin.package:
    name: "{{ container_runtime_cri_tools_package }}"
    state: present
  when:
    - container_runtime_install_cri_tools | bool
    - container_runtime_cri_tools_package | length > 0
    - container_runtime_crictl_probe.rc != 0

- name: Ensure containerd config directory exists
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"
  when: container_runtime_name == 'containerd'

- name: Configure containerd
  ansible.builtin.template:
    src: containerd-config.toml.j2
    dest: "{{ containerd_config_path }}"
    mode: "0644"
  when:
    - container_runtime_name == 'containerd'
    - container_runtime_manage_config | bool
  notify: Restart containerd

- name: Configure crictl endpoint
  ansible.builtin.copy:
    dest: /etc/crictl.yaml
    mode: "0644"
    content: |
      runtime-endpoint: {{ 'unix:///run/containerd/containerd.sock' if container_runtime_name == 'containerd' else 'unix:///var/run/crio/crio.sock' }}
      image-endpoint: {{ 'unix:///run/containerd/containerd.sock' if container_runtime_name == 'containerd' else 'unix:///var/run/crio/crio.sock' }}
      timeout: 10
      debug: false

- name: Ensure container runtime service is enabled
  ansible.builtin.service:
    name: "{{ 'containerd' if container_runtime_name == 'containerd' else 'crio' }}"
    enabled: true
    state: started
