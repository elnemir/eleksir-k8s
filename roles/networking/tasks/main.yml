# ## Задача: Роль networking
# - **Статус**: В процессе
# - **Описание**: Применение CNI и сетевых политик.
- name: Validate CNI selection
  ansible.builtin.assert:
    that:
      - network_cni in ['calico', 'cilium', 'flannel']
      - network_manifest_urls[network_cni] is defined
    fail_msg: "Unsupported CNI plugin"

- name: Wait for Kubernetes API availability
  ansible.builtin.command: kubectl --kubeconfig={{ network_kubeconfig }} get nodes
  register: kube_api_wait
  retries: 20
  delay: 15
  until: kube_api_wait.rc == 0
  changed_when: false

- name: Apply CNI manifest
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    apply -f {{ network_manifest_urls[network_cni] }}
  register: networking_apply
  changed_when: "'created' in networking_apply.stdout or 'configured' in networking_apply.stdout"
  environment: "{{ proxy_environment }}"

- name: Configure Calico backend mode via ConfigMap
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system patch configmap calico-config --type merge
    -p '{"data":{"calico_backend":"{{ network_calico_backend }}"}}'
  register: networking_calico_config_patch
  changed_when: "'(no change)' not in (networking_calico_config_patch.stdout | default(''))"
  when: network_cni == 'calico'

- name: Configure Calico node tunnel env vars
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system patch daemonset calico-node --type strategic
    -p '{"spec":{"template":{"spec":{"containers":[{"name":"calico-node","env":[{"name":"CALICO_IPV4POOL_IPIP","value":"{{ network_calico_ipv4pool_ipip }}"},{"name":"CALICO_IPV4POOL_VXLAN","value":"{{ network_calico_ipv4pool_vxlan }}"}]}]}}}}'
  register: networking_calico_ds_patch
  changed_when: "'(no change)' not in (networking_calico_ds_patch.stdout | default(''))"
  when: network_cni == 'calico'

- name: Configure Calico node cluster type for selected backend
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system patch daemonset calico-node --type strategic
    -p '{"spec":{"template":{"spec":{"containers":[{"name":"calico-node","env":[{"name":"CLUSTER_TYPE","value":"{{ network_calico_cluster_type }}"}]}]}}}}'
  register: networking_calico_cluster_type_patch
  changed_when: "'(no change)' not in (networking_calico_cluster_type_patch.stdout | default(''))"
  when: network_cni == 'calico'

- name: Configure Calico node health checks for VXLAN mode
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system patch daemonset calico-node --type strategic
    -p '{"spec":{"template":{"spec":{"containers":[{"name":"calico-node","livenessProbe":{"exec":{"command":["/bin/calico-node","-felix-live"]}},"readinessProbe":{"exec":{"command":["/bin/calico-node","-felix-ready"]}}}]}}}}'
  register: networking_calico_probe_patch
  changed_when: "'(no change)' not in (networking_calico_probe_patch.stdout | default(''))"
  when:
    - network_cni == 'calico'
    - network_calico_backend == 'vxlan'

- name: Restart Calico components when backend settings changed
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system rollout restart daemonset/calico-node deployment/calico-kube-controllers
  changed_when: true
  when:
    - network_cni == 'calico'
    - ("(no change)" not in (networking_calico_config_patch.stdout | default('')))
      or ("(no change)" not in (networking_calico_ds_patch.stdout | default('')))
      or ("(no change)" not in (networking_calico_cluster_type_patch.stdout | default('')))
      or ("(no change)" not in (networking_calico_probe_patch.stdout | default('(no change)')))

- name: Wait for CNI DaemonSet rollout (calico)
  block:
    - name: Wait for calico-node DaemonSet rollout
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ network_kubeconfig }}
        -n kube-system rollout status daemonset/calico-node --timeout={{ network_cni_rollout_timeout }}
      register: networking_calico_rollout
      changed_when: false
      retries: "{{ network_cni_rollout_retries | int }}"
      delay: "{{ network_cni_rollout_delay | int }}"
      until: networking_calico_rollout.rc == 0
  rescue:
    - name: Collect kube-system pods diagnostics after calico rollout timeout
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ network_kubeconfig }}
        -n kube-system get pods -o wide
      register: networking_calico_pods_diag
      changed_when: false
      failed_when: false

    - name: Collect calico-node DaemonSet description after rollout timeout
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ network_kubeconfig }}
        -n kube-system describe daemonset calico-node
      register: networking_calico_ds_diag
      changed_when: false
      failed_when: false

    - name: Collect kube-system events after calico rollout timeout
      ansible.builtin.command: >-
        kubectl --kubeconfig={{ network_kubeconfig }}
        -n kube-system get events --sort-by=.lastTimestamp
      register: networking_calico_events_diag
      changed_when: false
      failed_when: false

    - name: Fail with calico rollout diagnostics
      ansible.builtin.fail:
        msg: |
          Calico DaemonSet rollout timed out.
          rollout rc={{ networking_calico_rollout.rc | default('n/a') }}
          rollout stderr={{ networking_calico_rollout.stderr | default('') | trim }}
          kube-system pods:
          {{ networking_calico_pods_diag.stdout | default('') | trim }}
          calico-node describe:
          {{ networking_calico_ds_diag.stdout | default('') | trim }}
          kube-system events:
          {{ networking_calico_events_diag.stdout | default('') | trim }}
  when: network_cni == 'calico'
