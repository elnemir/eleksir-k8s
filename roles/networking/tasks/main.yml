# ## Задача: Роль networking
# - **Статус**: В процессе
# - **Описание**: Применение CNI и сетевых политик.
- name: Validate CNI selection
  ansible.builtin.assert:
    that:
      - network_cni in ['calico', 'cilium', 'flannel']
      - network_manifest_urls[network_cni] is defined
    fail_msg: "Unsupported CNI plugin"

- name: Wait for Kubernetes API availability
  ansible.builtin.command: kubectl --kubeconfig={{ network_kubeconfig }} get nodes
  register: kube_api_wait
  retries: 20
  delay: 15
  until: kube_api_wait.rc == 0
  changed_when: false

- name: Apply CNI manifest
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    apply -f {{ network_manifest_urls[network_cni] }}
  register: networking_apply
  changed_when: "'created' in networking_apply.stdout or 'configured' in networking_apply.stdout"
  environment: "{{ proxy_environment }}"

- name: Wait for CNI DaemonSet rollout (calico)
  ansible.builtin.command: >-
    kubectl --kubeconfig={{ network_kubeconfig }}
    -n kube-system rollout status daemonset/calico-node --timeout=300s
  when: network_cni == 'calico'
  changed_when: false
