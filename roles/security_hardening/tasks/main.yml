# ## Задача: Роль security_hardening
# - **Статус**: В процессе
# - **Описание**: Применение политик безопасности ОС.
- name: Validate security variables
  ansible.builtin.assert:
    that:
      - selinux_target_mode in ['Enforcing', 'Permissive', 'Disabled']
      - firewall_allowed_tcp is defined
      - firewall_allowed_udp is defined
      - firewall_allowed_protocols is defined
    fail_msg: "Security variables are incomplete"

- name: Ensure firewalld package is installed
  ansible.builtin.package:
    name: firewalld
    state: present
  when: firewalld_enabled | bool

- name: Ensure firewalld service is running
  ansible.builtin.service:
    name: firewalld
    enabled: true
    state: started
  when: firewalld_enabled | bool

- name: Set SELinux mode
  ansible.posix.selinux:
    policy: targeted
    state: "{{ selinux_target_mode }}"

- name: Build firewalld TCP ports list
  ansible.builtin.set_fact:
    security_firewall_tcp_ports: "{{ firewall_allowed_tcp | map('string') | map('regex_replace', '$', '/tcp') | list }}"
  when: firewalld_enabled | bool

- name: Build firewalld UDP ports list
  ansible.builtin.set_fact:
    security_firewall_udp_ports: "{{ firewall_allowed_udp | map('string') | map('regex_replace', '$', '/udp') | list }}"
  when: firewalld_enabled | bool

- name: Build firewalld protocols list
  ansible.builtin.set_fact:
    security_firewall_protocols: "{{ firewall_allowed_protocols | map('string') | list }}"
  when: firewalld_enabled | bool

- name: Configure firewalld TCP ports
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ security_firewall_tcp_ports }}"
  when: firewalld_enabled | bool

- name: Configure firewalld UDP ports
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ security_firewall_udp_ports }}"
  when: firewalld_enabled | bool

- name: Configure firewalld allowed protocols
  ansible.posix.firewalld:
    protocol: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ security_firewall_protocols }}"
  when:
    - firewalld_enabled | bool
    - security_firewall_protocols | length > 0

- name: Ensure firewalld is enabled persistently
  ansible.posix.firewalld:
    state: enabled
    permanent: true
    immediate: true
  when: firewalld_enabled | bool
